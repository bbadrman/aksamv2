{% extends 'base.html.twig' %}

{% block title %}Détails
	{{ commercial.nom }}
	{{ commercial.prenom }}
	- Statistiques Prospects
{% endblock %}

{% block body %}
<div class="container-fluid">
	<div class="row">
		<div
			class="col-12">
			{# En-tête avec navigation #}
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h1 class="h3 mb-0">
					<i class="fas fa-user-tie"></i>
					Détails du commercial :
					{{ commercial.nom }}
					{{ commercial.prenom }}
				</h1>
				<div>
					<a href="{{ path('app_prospect_stats', { 'startDate': startDate, 'endDate': endDate, 'commercial': commercial.id, 'filter': 'commercial' }) }}" class="btn btn-secondary">
						<i class="fas fa-arrow-left"></i>
						Retour aux statistiques
					</a>
				</div>
			</div>

			{# Informations commercial #}
			<div class="row mb-4">
				<div
					class="col-md-8">
					{# Informations période #}
					{% if startDate and endDate %}
						<div class="alert alert-info">
							<i class="fas fa-calendar-alt"></i>
							<strong>Période :</strong>
							Du
							{{ startDate|date('d/m/Y') }}
							au
							{{ endDate|date('d/m/Y') }}
							<span class="ms-3">
								<strong>Total prospects :</strong>
								<span class="badge bg-primary fs-6">{{ prospects|length }}</span>
							</span>
						</div>
					{% else %}
						<div class="alert alert-info">
							<i class="fas fa-calendar-alt"></i>
							<strong>Période :</strong>
							Toutes les dates
							<span class="ms-3">
								<strong>Total prospects :</strong>
								<span class="badge bg-primary fs-6">{{ prospects|length }}</span>
							</span>
						</div>
					{% endif %}
				</div>
				<div
					class="col-md-4">
					{# Informations du commercial #}
					<div class="card">
						<div class="card-body text-center">
							<i class="fas fa-user-circle fa-3x text-primary mb-2"></i>
							<h5>{{ commercial.nom }}
								{{ commercial.prenom }}</h5>
							{% if commercial.email %}
								<p class="mb-1">
									<i class="fas fa-envelope"></i>
									{{ commercial.email }}</p>
							{% endif %}
							{% if commercial.telephone %}
								<p class="mb-1">
									<i class="fas fa-phone"></i>
									{{ commercial.telephone }}</p>
							{% endif %}
							{% if commercial.equipe %}
								<p class="mb-0">
									<i class="fas fa-users"></i>
									Équipe:
									{{ commercial.equipe.nom }}</p>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

			{% if prospects is not empty %}
				{# Statistiques rapides #}
				<div class="row mb-4">
					<div class="col-md-3">
						<div class="card text-center bg-primary text-white">
							<div class="card-body">
								<h4>{{ prospects|length }}</h4>
								<p class="mb-0">Total Prospects</p>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center bg-success text-white">
							<div class="card-body">
								<h4>
									{% set particuliers = 0 %}
									{% for prospect in prospects %}
										{% if prospect.typeProspect == '1' %}
											{% set particuliers = particuliers + 1 %}
										{% endif %}
									{% endfor %}
									{{ particuliers }}
								</h4>
								<p class="mb-0">Particuliers</p>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center bg-info text-white">
							<div class="card-body">
								<h4>
									{% set professionnels = 0 %}
									{% for prospect in prospects %}
										{% if prospect.typeProspect == '2' %}
											{% set professionnels = professionnels + 1 %}
										{% endif %}
									{% endfor %}
									{{ professionnels }}
								</h4>
								<p class="mb-0">Professionnels</p>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center bg-warning text-white">
							<div class="card-body">
								<h4>
									{% set thisMonth = prospects|filter(p => p.creatAt and p.creatAt|date('Y-m') == "now"|date('Y-m'))|length %}
									{{ thisMonth }}
								</h4>
								<p class="mb-0">Ce mois-ci</p>
							</div>
						</div>
					</div>
				</div>

				{# Performance commerciale #}
				<div class="row mb-4">
					<div class="col-md-6">
						<div class="card">
							<div class="card-header">
								<h6>
									<i class="fas fa-chart-line"></i>
									Performance mensuelle</h6>
							</div>
							<div class="card-body">
								<canvas id="performanceChart"></canvas>
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<div class="card">
							<div class="card-header">
								<h6>
									<i class="fas fa-bullseye"></i>
									Répartition des sources</h6>
							</div>
							<div class="card-body">
								<canvas id="sourceChart"></canvas>
							</div>
						</div>
					</div>
				</div>

				{# Tableau détaillé des prospects #}
				<div class="card">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="fas fa-list"></i>
							Liste détaillée des prospects
						</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-striped table-hover" id="prospectsTable">
								<thead class="table-dark">
									<tr>
										<th>Date</th>
										<th>Nom/Prénom</th>
										<th>Email</th>
										<th>Téléphone</th>
										<th>Ville</th>
										<th>Type</th>
										<th>Source</th>
										<th>Activité</th>
										<th>Statut</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									{% for prospect in prospects %}
										<tr>
											<td>
												{% if prospect.creatAt %}
													{{ prospect.creatAt|date('d/m/Y H:i') }}
												{% else %}
													<span class="text-muted">-</span>
												{% endif %}
											</td>
											<td>
												<strong>{{ prospect.nom|default('-') }}</strong>
												{% if prospect.prenom %}
													<br><small class="text-muted">{{ prospect.prenom }}</small>
												{% endif %}
											</td>
											<td>
												{% if prospect.email %}
													<a href="mailto:{{ prospect.email }}" class="text-decoration-none">
														<i class="fas fa-envelope"></i>
														{{ prospect.email }}
													</a>
												{% else %}
													<span class="text-muted">-</span>
												{% endif %}
											</td>
											<td>
												{% if prospect.telephone %}
													<a href="tel:{{ prospect.telephone }}" class="text-decoration-none">
														<i class="fas fa-phone"></i>
														{{ prospect.telephone }}
													</a>
												{% else %}
													<span class="text-muted">-</span>
												{% endif %}
											</td>
											<td>
												{% if prospect.ville %}
													<small>{{ prospect.ville }}</small>
												{% else %}
													<span class="text-muted">-</span>
												{% endif %}
											</td>
											<td>
												{% if prospect.typeProspect == '1' %}
													<span class="badge bg-success">Particulier</span>
												{% elseif prospect.typeProspect == '2' %}
													<span class="badge bg-info">Professionnel</span>
												{% else %}
													<span class="badge bg-secondary">Inconnu</span>
												{% endif %}
											</td>
											<td>
												{% set sourceMapping = {
                                                    '1': 'Parrainage',
                                                    '2': 'Appel Entrant',
                                                    '3': 'Avenant',
                                                    '4': 'Ancienne contrat',
                                                    '5': 'Propre site',
                                                    '6': 'Revendeur',
                                                    '7': 'Hors cible',
                                                    '8': 'Test'
                                                } %}
												<small class="badge bg-light text-dark">
													{{ sourceMapping[prospect.motifSaise]|default('Inconnu') }}
												</small>
											</td>
											<td>
												{% set activiteMapping = {
                                                    '1': 'TPM',
                                                    '2': 'VTC',
                                                    '3': 'Sociéte',
                                                    '4': 'Décenale',
                                                    '5': 'Dommage',
                                                    '6': 'Marchandise',
                                                    '7': 'Négociant',
                                                    '8': 'Prof auto',
                                                    '9': 'Garage'
                                                } %}
												{% if prospect.activites %}
													<small class="badge bg-secondary">
														{{ activiteMapping[prospect.activites]|default('Inconnu') }}
													</small>
												{% else %}
													<span class="text-muted">-</span>
												{% endif %}
											</td>
											<td>
												{% if prospect.statut %}
													<span class="badge bg-warning">{{ prospect.statut }}</span>
												{% else %}
													<span class="badge bg-secondary">En attente</span>
												{% endif %}
											</td>
											<td>
												<div
													class="btn-group btn-group-sm" role="group">
													{# Boutons d'action - à adapter selon vos routes #}
													<button type="button" class="btn btn-outline-primary btn-sm" title="Voir détails" onclick="viewProspect({{ prospect.id }})">
														<i class="fas fa-eye"></i>
