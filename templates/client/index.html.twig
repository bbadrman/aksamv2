{% extends 'base.html.twig' %}

{% block title %}Client index
{% endblock %}

{% block body %}
	{% for label, messages in app.flashes %}
		<div class="container">
			<div class="alert alert-{{ label }}">
				{% for message in messages %}
					{{ message|raw }}
				{% endfor %}
			</div>
		</div>
	{% endfor %}

	<section class="content-header">
		<h2>Clients</h2>
		<ol class="breadcrumb">
			<li>
				<a href="{{ path('app_home') }}">
					<i class="fa fa-dashboard"></i>
					Tableau de bord
				</a>
			</li>
			<li class="active">
				<a href="{{ path('client_index') }}">
					<i class="fa fa-object-fonction"></i>
					Tous les clients
				</a>
			</li>
		</ol>
	</section>

	<div class="col-xs-12 mx-auto d-flex justify-content-center">
		<div class="row" style="margin-right: 12px;">
			{% include 'client/_search_form.html.twig' with {search_form: search_form} only %}
		</div>
	</div>

	<div class="row mt">
		<div class="col-lg-12">
			<div class="content-panel">
				<table class="table table-striped table-advance table-hover">
					<thead>
						<tr>
							<th>Equipe</th>
							<th>Commercial</th>
							<th>Nom</th>
							<th>Prénom</th>
							<th>Téléphone</th>
							<th>Email</th>
							<th>Raison Sociale</th>
							<th>Adresse</th>
							<th>Créé le</th>
							<th>Forme Juridique</th>
							<th style="text-align:center;">Nbr Contrats</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for client in clients %}
							<tr class="expandable-row client-row">
								<td>{{ client.team }}</td>
								<td>{{ client.cmrcl }}</td>
								<td>{{ client.nom }}</td>
								<td>{{ client.prenom }}</td>
								{% if  is_granted('ROLE_ADMIN') or  is_granted('ROLE_CLIENT') or  app.user == client.cmrcl %}
									<td>{{ client.phone }}</td>
									<td>{{ client.email }}</td>
								{% else %}
									<td>—</td>
									<td>—</td>
								{% endif %}
								<td>{{ client.raisonSociale }}</td>
								<td>{{ client.adress }}</td>
								<td>{{ client.creatAt ? client.creatAt|date('Y-m-d H:i') : '' }}</td>
								<td>
									{% set formes = {
                                        1: 'SARL', 2: 'EI', 3: 'EURL', 4: 'SA', 5: 'SAS',
                                        6: 'SASU', 7: 'SNC', 8: 'SCOP', 9: 'Association'
                                    } %}
									{{ formes[client.forceJuridique] ?? '' }}
								</td>
								<td style="text-align:center;">
									{{ client.contrats|filter(contrat => contrat.status == 1)|length }}
								</td>
								<td class="btn-toolbar">
									{% if client.status == 1 %}
										<a href="{{ path('app_contrat_new', {'id': client.id}) }}" class="btn btn-success btn-xs">CONTRAT</a>
									{% elseif client.status == 2 %}
										{% if app.user == client.cmrcl %}
											<a href="{{ path('client_valide_edit', {'id': client.id}) }}" class="btn btn-danger btn-xs">REJETER</a>
										{% elseif client.isModifie == 1 %}
											<a href="{{ path('app_client_edit', {'id': client.id}) }}" class="btn btn-xs" style="background-color:#98FB98;">MODIFIÉ</a>
										{% else %}
											<a href="{{ path('app_client_edit', {'id': client.id}) }}" class="btn btn-danger btn-xs">REJETER</a>
										{% endif %}

									{% elseif client.status is null %}
										{% if is_granted('ROLE_VALID') and app.user == client.cmrcl %}
											<a href="{{ path('client_valide_edit', {'id': client.id}) }}" class="btn btn-success btn-xs">MYCLIENT</a>
										{% else %}
											{% if is_granted('ROLE_VALID') %}
												<a href="{{ path('app_client_edit', {'id': client.id}) }}" class="btn btn-primary btn-xs">NOUVEAU</a>
											{% else %}
												En vérification
											{% endif %}
										{% endif %}
									{% endif %}

									{% if is_granted('ROLE_ADMIN') %}
										<a href="{{ path('client_valide_edit', {'id': client.id}) }}" class="btn btn-primary btn-xs">
											<i class="fa fa-pencil"></i>
										</a>
									{% endif %}
								</td>
							</tr>

							<tr class="expanded-content contract-row" style="display: none;">
								<td colspan="12">
									<table class="table table-bordered">
										<thead>
											<tr>
												<th>
													<i class="fa fa-handshake-o" aria-hidden="true"></i>
													CONTRAT</th>
												<th>État</th>
												<th>Commercial</th>
												<th>Produit</th>
												<th>Immatriculation</th>
												<th>Date d'effet</th>
												<th>Date souscription</th>
												<th>Partenaire</th>
												<th>Compagnie</th>
												<th>Formule</th>
												<th>Cotisation</th>
												<th>Frais</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for contrat in client.contrats|filter(contrat => contrat.status == 1) %}
												<tr class="expandable-row contrat-row">
													<td></td>
													{% if is_granted('ROLE_ETATCONTRAT') %}
														<td>{{ contrat.etat }}{{ render(controller('App\\Controller\\ContratController::etat',{'id':contrat.id}))}}</td>
													{% else %}
														<td>{{ contrat.etat }}</td>
													{% endif %}
													<td>{{ contrat.user }}</td>
													<td>{{ contrat.product }}</td>
													<td>{{ contrat.imatriclt }}</td>
													<td>{{ contrat.dateEffet ? contrat.dateEffet|date('Y-m-d') : '' }}</td>
													<td>{{ contrat.dateSouscrpt ? contrat.dateSouscrpt|date('Y-m-d') : '' }}</td>
													<td>{{ contrat.partenaire ? contrat.partenaire.nom : '' }}</td>
													<td>{{ contrat.compagnie ? contrat.compagnie.nom : '' }}</td>
													<td>{{ contrat.formule }}</td>
													<td>{{ contrat.cotisation }}</td>
													<td>{{ contrat.frais }}</td>
													<td>
														{% if contrat.payments %}
															{{ render(controller('App\\Controller\\PaymentController::editpayment', {'id': contrat.id})) }}
														{% else %}
															{{ render(controller('App\\Controller\\PaymentController::newpayment', {'id': contrat.id})) }}
														{% endif %}

														{# {{ render(controller('App\\Controller\\PaymentController::newpayment', {'id': contrat.id})) }} #}
														{# {{ render(controller('App\\Controller\\ContratController::paiement', {'id': contrat.id})) }} #}


														{% if contrat.document and is_granted('ROLE_DOCUMENT_EDIT') %}
															<a href="{{ path('app_document_edit', {'id': contrat.document.id}) }}" class="btn btn-info">
																<i class="fa-solid fa-copy"></i>
															</a>

														{% endif %}
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</td>
							</tr>
						{% endfor %}
					</tbody>
					<tfoot class="text-right">
						<tr>
							<td colspan="12">{{ knp_pagination_render(clients, 'pagination.html.twig') }}</td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script>
		$(document).ready(function () {
$('.client-row').click(function () {
$(this).next('.contract-row').toggle();
});

$('.contrat-row').click(function () {
$(this).next('.sav-row').toggle();
});
});
	</script>
{% endblock %}
