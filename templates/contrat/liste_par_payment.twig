{% extends 'base.html.twig' %}

{% block title %}Statistiques des contrats du mois
{% endblock %}

{% block body %}
	{% for label,  messages in app.flashes  %}
		<div class="container">
			<div class="alert alert-{{ label }}">
				{% for message in messages %}
					{{ message | raw }}
				{% endfor %}

			</div>
		</div>
	{% endfor %}
	{% for message in app.flashes('warning') %}
		<div class="alert alert-warning">
			{{ message }}
		</div>
	{% endfor %}
	<div class="row mt">
		<div class="col-lg-12">
			<div class="content-panel">
				<section class="content-header">

					<h1 style="text-align: center;">Chiffres d'Affaires du Mois
					</h1>

					<div style="text-align: right;">

						<button type="button" class="btn btn-info">
							<a href="{{path('bycalendrie')}}">CHERCHER PAR CALENDRIER</a>
						</button>
					</div>


					<ol class="breadcrumb">
						<li>
							<a href="{{ path('app_home') }}">
								<i class="fa fa-dashboard"></i>
								Tableau de bord</a>
						</li>
					</ol>
				</section>

				<hr>
				<table id="contrat-stats" class="table table-striped table-hover table-bordered">


					<thead>
						<tr>
							<th class="text-right">Commercial</th>
							<th class="text-right">Nombre de contrats</th>
							<th class="text-right sortable" data-sort="frais" style="cursor:pointer;">Total frais déclarés &emsp;
								<i class="fa-solid fa-sort"></i>
							</th>
							<th class="text-right sortable" data-sort="frais_caisses" style="cursor:pointer;">Total frais en caisses  &emsp;
								<i class="fa-solid fa-sort"></i>
							</th>

						</tr>
					</thead>
					<tbody>
						{% set totalFraisGlobal = 0 %}
						{% set totalCreditGlobal = 0 %}

						{% for user in users %}
							{% set contrats = user.contrats %}
							{% if contrats is not empty %}
								{% set totalFrais = 0 %}
								{% set totalCredit = 0 %}

								{% for contrat in contrats %}
									{# Calcul des frais à partir des paiements #}
									{% for payment in contrat.payments %}
										{% set totalFrais = totalFrais + (payment.frais ?? 0) %}
									{% endfor %}

									{# Calcul des crédits comme avant #}
									{% for reglement in contrat.regelement %}
										{% if reglement.transaction %}
											{% set credit = reglement.transaction|credit_by_transaction %}
											{% set totalCredit = totalCredit + credit %}
										{% endif %}
									{% endfor %}
								{% endfor %}

								{% set totalFraisGlobal = totalFraisGlobal + totalFrais %}
								{% set totalCreditGlobal = totalCreditGlobal + totalCredit %}

								<tr class="commercial-summary" data-target="details-{{ loop.index }}">
									<td class="bg-light">
										<button class="btn btn-info">
											{{ user.username }}
											<i class="fas fa-angle-down mr-2"></i>
										</button>
									</td>
									<td class="text-right">{{ user.contrats|length }}</td>
									<td class="frais-value" data-value="{{ totalFrais }}">
										<strong>{{ totalFrais|number_format(2, ',', ' ') }}
											€</strong>
									</td>
									<td class="caisses-value" data-value="{{ totalCredit }}">
										<strong>{{ totalCredit|number_format(2, ',', ' ') }}
											€</strong>
									</td>
								</tr>

								{# Détails des contrats et paiements #}
								{% for contrat in user.contrats %}
									<tr class="contract-details details-{{ loop.parent.loop.index }}" style="display: none;">
										<td></td>
										<td>{{ contrat.nom }}</td>
										<td>
											{% for payment in contrat.payments %}
												<div>
													Paiement du
													{{ payment.creatAt|date('d/m/Y') }}
													- 
													                                Frais:
													{{ payment.frais|number_format(2, ',', ' ') }}
													€
												</div>
											{% endfor %}
										</td>
										<td>
											{% for reglement in contrat.regelement %}
												{% if reglement.transaction %}
													<div>
														Transaction
														{{ reglement.transaction }}
														-
														                                    Credit:
														{{ reglement.transaction|credit_by_transaction }}
														€
													</div>
												{% endif %}
											{% endfor %}
										</td>
									</tr>
								{% endfor %}
							{% endif %}
						{% endfor %}

						<tr style="font-weight: bold; background-color:#f5f5f5;">
							<td>TOTAL GÉNÉRAL:</td>
							<td></td>
							<td>{{ totalFraisGlobal|number_format(2, ',', ' ') }}
								€</td>
							<td>{{ totalCreditGlobal|number_format(2, ',', ' ') }}
								€</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
	<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
const summaryRows = document.querySelectorAll('.commercial-summary');

summaryRows.forEach(row => {
row.addEventListener('click', function () {
const targetClass = this.dataset.target;
const detailRows = document.querySelectorAll (`.contract-details.${targetClass}`);

detailRows.forEach(row => {
row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
});
});
});

let sortAscFrais = true;
let sortAscCaisses = true;

// Tri pour "Total frais déclarés"
document.querySelector('.sortable[data-sort="frais"]').addEventListener('click', function () {
const tbody = document.querySelector('#contrat-stats tbody');
const allRows = Array.from(tbody.querySelectorAll('tr'));

const blocks = [];
for (let i = 0; i < allRows.length; i++) {
const row = allRows[i];
if (row.classList.contains('commercial-summary')) {
const details = [];
const targetClass = row.dataset.target;
let j = i + 1;

while (j < allRows.length && allRows[j].classList.contains('contract-details') && allRows[j].classList.contains(targetClass)) {
details.push(allRows[j]);
j++;
}

const totalFrais = parseFloat(row.querySelector('.frais-value').dataset.value);
blocks.push({summary: row, details, totalFrais});
i = j - 1;
}
}

// Trie les blocs
blocks.sort((a, b) => {
return sortAscFrais ? b.totalFrais - a.totalFrais : a.totalFrais - b.totalFrais;
});

// Réinsère les blocs
tbody.innerHTML = '';
blocks.forEach(block => {
tbody.appendChild(block.summary);
block.details.forEach(d => tbody.appendChild(d));
});

sortAscFrais = ! sortAscFrais;
});

// Tri pour "Total frais en caisses"
document.querySelector('.sortable[data-sort="frais_caisses"]').addEventListener('click', function () {
const tbody = document.querySelector('#contrat-stats tbody');
const allRows = Array.from(tbody.querySelectorAll('tr'));

const blocks = [];
for (let i = 0; i < allRows.length; i++) {
const row = allRows[i];
if (row.classList.contains('commercial-summary')) {
const details = [];
const targetClass = row.dataset.target;
let j = i + 1;

while (j < allRows.length && allRows[j].classList.contains('contract-details') && allRows[j].classList.contains(targetClass)) {
details.push(allRows[j]);
j++;
}

const totalCredit = parseFloat(row.querySelector('.caisses-value').dataset.value);
blocks.push({summary: row, details, totalCredit});
i = j - 1;
}
}

// Trie les blocs
blocks.sort((a, b) => {
return sortAscCaisses ? b.totalCredit - a.totalCredit : a.totalCredit - b.totalCredit;
});

// Réinsère les blocs
tbody.innerHTML = '';
blocks.forEach(block => {
tbody.appendChild(block.summary);
block.details.forEach(d => tbody.appendChild(d));
});

sortAscCaisses = ! sortAscCaisses;
});
});
	</script>

{% endblock %}
