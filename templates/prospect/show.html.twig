{% extends 'base.html.twig' %}

{% block title %}Information du
	{{ prospect.nom }}
	{{ prospect.prenom }}
	- Aksam
{% endblock %}

{% block body %}
	<div
		class="header-show">
		<!-- Messages flash -->
		{% for label, messages in app.flashes %}
			<div class="flash-messages">
				{% for message in messages %}
					<div class="alert alert-{{ label }}">
						<i class="fas fa-{% if label == 'success' %}check-circle{% elseif label == 'danger' %}exclamation-triangle{% elseif label == 'info' %}info-circle{% else %}bell{% endif %}"></i>
						{{ message | raw }}
					</div>
				{% endfor %}
			</div>
		{% endfor %}

		<!-- Header moderne -->
		<div class="modern-header">
			<div class="header-content">
				<h1 class="header-title">
					<i class="fas fa-user-circle"></i>
					Profil Prospect
				</h1>
				<p class="header-subtitle">Informations détaillées et historique complet</p>
			</div>
		</div>

		<!-- Breadcrumb moderne -->
		<nav class="modern-breadcrumb">
			<a href="#" class="breadcrumb-item">
				<i class="fas fa-users"></i>
				Toutes les Tables
			</a>
			<span class="breadcrumb-separator">•</span>
			<a href="{{ path('app_prospect_index') }}" class="breadcrumb-item">
				<i class="fas fa-diamond"></i>
				Tous les prospects
			</a>
			<span class="breadcrumb-separator">•</span>
			<span class="breadcrumb-item" style="color: #4facfe;">
				<i class="fas fa-user-circle"></i>
				{{ prospect.nom }}
				{{ prospect.prenom }}
			</span>
		</nav>

		<!-- Profil du prospect -->
		<div class="prospect-profile">
			<div class="prospect-header">
				<div class="prospect-avatar-large">
					{{ prospect.nom|first|upper }}{{ prospect.prenom|first|upper }}
				</div>
				<div class="prospect-info">
					<h2>{{ prospect.nom }}
						{{ prospect.prenom }}</h2>
					<p>
						{% if prospect.email %}
							<span class="prospect-detail">
								<i class="fas fa-envelope"></i>
								{{ prospect.email }}
							</span>
						{% endif %}
						{% if prospect.phone %}
							<span class="prospect-detail">
								<i class="fas fa-phone"></i>
								{{ prospect.phone }}
							</span>
						{% endif %}
						{% if prospect.city %}
							<span class="prospect-detail">
								<i class="fas fa-map-marker-alt"></i>
								{{ prospect.city }}
							</span>
						{% endif %}
						{% if prospect.creatAt %}
							<span class="prospect-detail">
								<i class="fas fa-calendar-plus"></i>
								Créé le
								{{ prospect.creatAt|date('d/m/Y') }}
							</span>
						{% endif %}
					</p>
				</div>
			</div>
		</div>

		<!-- Grille d'informations -->
		<div
			class="info-grid">
			<!-- Carte Informations -->
			<div class="info-card card-informations">
				<div class="info-card-header">
					<h4>
						<i class="fas fa-user"></i>
						Informations
					</h4>
				</div>
				<div class="info-card-body">
					<table class="table-modern">
						<tbody>
							<tr>
								<th>Nom</th>
								<td>{{ prospect.nom|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Prénom</th>
								<td>{{ prospect.prenom|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Téléphone 1</th>
								<td>{{ prospect.phone|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Téléphone 2</th>
								<td>
									<div class="inline-form">
										{{ form_start(gsmForm) }}
										{{ form_widget(gsmForm.gsm) }}
										<button type="submit">
											<i class="fas fa-save"></i>
										</button>
										{{ form_end(gsmForm) }}
									</div>
								</td>
							</tr>
							<tr>
								<th>Email</th>
								<td>{{ prospect.email|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Email 2</th>
								<td>
									<div class="inline-form">
										{{ form_start(emailForm) }}
										{{ form_widget(emailForm.secdEmail) }}
										<button type="submit">
											<i class="fas fa-save"></i>
										</button>
										{{ form_end(emailForm) }}
									</div>
								</td>
							</tr>
							<tr>
								<th>Genre</th>
								<td>{{ prospect.gender|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Ville</th>
								<td>{{ prospect.city|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Adresse</th>
								<td>{{ prospect.adress|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Date de naissance</th>
								<td>{{ prospect.brithAt ? prospect.brithAt|date('d/m/Y') : 'Non renseigné' }}</td>
							</tr>
							<tr>
								<th>Source</th>
								<td>{{ prospect.source|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Type Prospect</th>
								<td>{{ prospect.typeProspect|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Raison Sociale</th>
								<td>{{ prospect.raisonSociale|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Code Postal</th>
								<td>{{ prospect.codePost|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Assuré</th>
								<td>{{ prospect.assurer|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Dernier Assureur</th>
								<td>{{ prospect.lastAssure|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Motif Résiliation</th>
								<td>{{ prospect.motifResil|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Motif Saisie</th>
								<td>{{ prospect.motifSaise|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>URL</th>
								<td>{{ prospect.url|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Second Email</th>
								<td>{{ prospect.secdEmail|default('Non renseigné') }}</td>
							</tr>
							<tr>
								<th>Créé le</th>
								<td>{{ prospect.creatAt ? prospect.creatAt|date('d/m/Y H:i') : 'Non renseigné' }}</td>
							</tr>
							<tr>
								<th>Activités</th>
								<td>{{ prospect.activites|default('Non renseigné') }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Carte Relances -->
			<div class="info-card card-relances">
				<div class="info-card-header">
					<h4>
						<i class="fas fa-phone-alt"></i>
						Relances
					</h4>
				</div>
				<div class="info-card-body">
					<table class="table-modern">
						<thead>
							<tr>
								<th>Statut</th>
								<th>Date</th>
								<th>Commentaire</th>
							</tr>
						</thead>
						<tbody>
							{% for relance in relanceHistory|sort((a, b) => b.relancedAt <=> a.relancedAt) %}
								<tr>
									<td>
										{% if relance.motifRelance is null %}
											<span class="status-badge status-default">Pas encore relancé</span>
										{% elseif relance.motifRelance == 1 %}
											<span class="status-badge status-rendez-vous">Rendez-vous</span>
										{% elseif relance.motifRelance == 2 %}
											<span class="status-badge status-injoignable">Injoignable</span>
										{% elseif relance.motifRelance == 3 %}
											<span class="status-badge status-attente">Attente DOC</span>
										{% elseif relance.motifRelance == 4 %}
											<span class="status-badge status-tarification">Tarification</span>
										{% elseif relance.motifRelance == 5 %}
											<span class="status-badge status-attente">Prise de Décision</span>
										{% elseif relance.motifRelance == 6 %}
											<span class="status-badge status-injoignable">Faux Fiche</span>
										{% elseif relance.motifRelance == 7 %}
											<span class="status-badge status-injoignable">Doublon</span>
										{% elseif relance.motifRelance == 8 %}
											<span class="status-badge status-injoignable">Passage Concurrent</span>
										{% elseif relance.motifRelance == 9 %}
											<span class="status-badge status-rendez-vous">Passage Client</span>
										{% elseif relance.motifRelance == 10 %}
											<span class="status-badge status-rendez-vous">Déjà Souscrit</span>
										{% elseif relance.motifRelance == 11 %}
											<span class="status-badge status-injoignable">Toujours Injoignable</span>
										{% elseif relance.motifRelance == 13 %}
											<span class="status-badge status-default">Test</span>
										{% endif %}
									</td>
									<td>{{ relance.relancedAt ? relance.relancedAt|date('d/m/Y H:i') : '' }}</td>
									<td class="truncated" onclick="showFullText(this)">
										<span class="shortened">{{ relance.comment|slice(0, 50) }}
											{% if relance.comment|length > 50 %}...
											{% endif %}
										</span>
										<span class="fullText" style="display: none;">{{ relance.comment }}</span>
									</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="3" class="text-center" style="color: #666; font-style: italic;">
										<i class="fas fa-info-circle"></i>
										Aucune relance enregistrée
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>

			<!-- Carte Historique -->
			<div class="info-card card-historique">
				<div class="info-card-header">
					<h4>
						<i class="fas fa-history"></i>
						Historique
					</h4>
				</div>
				<div class="info-card-body">
					<table class="table-modern">
						<thead>
							<tr>
								<th>Action</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody>
							{% for histor in teamHistory %}
								<tr>
									<td>
										<span class="status-badge status-default">
											Affecté au
											{{ histor.actionType }}
										</span>
									</td>
									<td>{{ histor.actionDate|date('d/m/Y H:i') }}</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="2" class="text-center" style="color: #666; font-style: italic;">
										<i class="fas fa-info-circle"></i>
										Aucun historique disponible
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>

					<!-- Bouton Appels -->
					<button type="button" class="btn-modern btn-calls" id="showCallsButton" data-id="{{ prospect.id }}">
						<i class="fas fa-phone"></i>
						Historique des Appels
					</button>
				</div>
			</div>
		</div>

		<!-- Boutons d'action -->
		<div class="action-buttons">
			<a href="{{ path('app_prospect_index') }}" class="btn-modern btn-back">
				<i class="fas fa-arrow-left"></i>
				Retour à la liste
			</a>
			{% if is_granted('ROLE_TRAITEMENT') %}
				<a href="{{ path('app_prospect_edit', {'id': prospect.id}) }}" class="btn-modern btn-edit">
					<i class="fas fa-edit"></i>
					Modifier
				</a>
			{% endif %}
		</div>

		<!-- Modal des appels -->
		<div class="modal fade" id="callsModal" tabindex="-1" aria-labelledby="callsModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h3 class="modal-title" id="callsModalLabel">
							<i class="fas fa-phone"></i>
							Historique des appels
						</h3>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="callsContent">
							<div class="text-center" style="padding: 2rem; color: #666;">
								<i class="fas fa-phone" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
								<p>Cliquez sur le bouton "Actualiser" pour charger les appels...</p>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">
							<i class="fas fa-times"></i>
							Fermer
						</button>
						<button type="button" class="btn btn-primary" id="refreshCallsButton">
							<i class="fas fa-sync-alt"></i>
							Actualiser
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script type="text/javascript">
		// Pour afficher comment onclick sur comment sur motifrelanced
function showFullText(element) {
var fullText = element.querySelector('.fullText');
var shortened = element.querySelector('.shortened');

if (fullText.style.display === 'none') {
fullText.style.display = 'inline';
shortened.style.display = 'none';
} else {
fullText.style.display = 'none';
shortened.style.display = 'inline';
}
}

// Script pour le modal des appels
document.addEventListener('DOMContentLoaded', function () {
const showCallsButton = document.getElementById('showCallsButton');
const refreshCallsButton = document.getElementById('refreshCallsButton');
const callsContent = document.getElementById('callsContent');
const callsModal = document.getElementById('callsModal');

function loadCalls(prospectId) {
if (callsContent) {
callsContent.innerHTML = `
                        <div class="text-center" style="padding: 2rem;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4facfe;"></i>
                            <p style="margin-top: 1rem; color: #666;">Chargement des appels...</p>
                        </div>
                    `;
}

fetch (`/appels/${prospectId}`).then(response => {
if (!response.ok) {
throw new Error (`HTTP error! status: ${
response.status
}`);
}
return response.text();
}).then(data => {
if (callsContent) {
callsContent.innerHTML = data;
}
}).catch(error => {
if (callsContent) {
callsContent.innerHTML = `
                                <div class="alert alert-danger" style="margin: 1rem;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Erreur lors du chargement des appels. Veuillez réessayer.
                                    <br><small>Détails: ${
error.message
}</small>
                                </div>
                            `;
}
});
}

// Initialiser le modal Bootstrap
let modalInstance;
if (callsModal) {
modalInstance = new bootstrap.Modal(callsModal);
}

// Événement sur le bouton d'ouverture du modal
if (showCallsButton) {
showCallsButton.addEventListener('click', function (e) {
e.preventDefault();
const prospectId = this.dataset.id;

if (prospectId) {
loadCalls(prospectId);
}

if (modalInstance) {
modalInstance.show();
}
});
}

// Événement sur le bouton de rafraîchissement
if (refreshCallsButton) {
refreshCallsButton.addEventListener('click', function () {
const prospectId = showCallsButton ? showCallsButton.dataset.id : null;
if (prospectId) {
loadCalls(prospectId);
}
});
}

// Auto-hide des messages flash après 5 secondes
const flashMessages = document.querySelectorAll('.flash-messages .alert');
flashMessages.forEach(alert => {
setTimeout(() => {
alert.style.opacity = '0';
alert.style.transform = 'translateY(-20px)';
setTimeout(() => {
alert.remove();
}, 300);
}, 5000);
});

// Animation de chargement des cartes
const infoCards = document.querySelectorAll('.info-card');
infoCards.forEach((card, index) => {
card.style.animationDelay = `${
index * 0.1
}s`;
});
});
	</script>
{% endblock %}
